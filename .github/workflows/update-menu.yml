name: Update menu

on:
  schedule:
    - cron: "0 5 * * 1"   # Mondays 05:00 UTC (06:00 Stockholm in winter, 07:00 in summer)
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
    pip install playwright requests
    python -m playwright install --with-deps chromium

      - name: Download PDF from Eatery page (auto-find link)
  env:
    MENU_PAGE_URL: ${{ secrets.MENU_PAGE_URL }}
  run: |
    python - <<'PY'
    import os
    from playwright.sync_api import sync_playwright

    url = os.environ["MENU_PAGE_URL"]

    with sync_playwright() as p:
      browser = p.chromium.launch()
      page = browser.new_page()
      page.goto(url, wait_until="networkidle")

      pdf_url = page.evaluate("""
        () => {
          const links = Array.from(document.querySelectorAll('a[href]'))
            .map(a => a.href)
            .filter(h => h && h.toLowerCase().includes('.pdf'));
          const preferred = links.find(h => /gate.*sv.*\\.pdf/i.test(h)) || links[0];
          return preferred || null;
        }
      """)

      if not pdf_url:
        raise SystemExit("No PDF link found on page")

      print("PDF:", pdf_url)

      resp = page.request.get(pdf_url)
      if not resp.ok:
        raise SystemExit(f"Failed to download PDF ({resp.status})")

      open("menu.pdf", "wb").write(resp.body())
      browser.close()
    PY

      - name: Convert first page to PNG
        run: |
          pdftoppm -png -f 1 -singlefile -rx 200 -ry 200 menu.pdf latest

      - name: Commit and push if changed
        run: |
          git config user.name "menu-bot"
          git config user.email "menu-bot@users.noreply.github.com"
          git add latest.png menu.pdf index.html
          git diff --staged --quiet || (git commit -m "Update menu" && git push)
