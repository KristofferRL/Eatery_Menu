name: Update menu

on:
  schedule:
    - cron: "0 5 * * 1" # Mondays 05:00 UTC
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          pip install playwright requests
          python -m playwright install --with-deps chromium

      - name: Download PDF from Eatery page (auto-find link)
        env:
          MENU_PAGE_URL: ${{ secrets.MENU_PAGE_URL }}
        run: |
          echo "Fetching menu page..."
          python - <<'PY'
          import os
          from playwright.sync_api import sync_playwright

          url = os.environ['MENU_PAGE_URL']

          with sync_playwright() as p:
              browser = p.chromium.launch()
              page = browser.new_page()
              page.goto(url, wait_until='networkidle')

              pdf_url = page.evaluate("""
                  () => {
                      const links = Array.from(document.querySelectorAll('[href],[src]'))
                          .map(el => el.href || el.src)
                          .filter(h => h && h.toLowerCase().includes('.pdf'));
                      const preferred = links.find(h => /gate.*sv.*\.pdf/i.test(h)) || links[0];
                      return preferred || null;
                  }
              """)

              if not pdf_url:
                  raise SystemExit("No PDF link found on page")

              print("PDF found:", pdf_url)

              resp = page.request.get(pdf_url)
              if not resp.ok:
                  raise SystemExit(f"Failed to download PDF ({resp.status})")

              open("menu.pdf", "wb").write(resp.body())
              browser.close()
          PY

